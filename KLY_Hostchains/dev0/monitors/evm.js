/**
 * 
 * 
 *                                                            * .           ..         .           .       .           .           .
 *                                                                 .         .            .          .       .
 *                                                                       .         ..xxxxxxxxxx....               .       .             .
 *                                                               .             MWMWMWWMWMWMWMWMWMWMWMWMW                       .
 *                                                                         IIIIMWMWMWMWMWMWMWMWMWMWMWMWMWMttii:        .           .
 *                                                            .      IIYVVXMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWxx...         .           .
 *                                                                IWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMx..
 *                                                              IIWMWMWMWMWMWMWMWMWBY%ZACH%AND%OWENMWMWMWMWMWMWMWMWMWMWMWMWMx..        .
 *                                                               ""MWMWMWMWMWM"""""""".  .:..   ."""""MWMWMWMWMWMWMWMWMWMWMWMWMWti.
 *                                                            .     ""   . `  .: . :. : .  . :.  .  . . .  """"MWMWMWMWMWMWMWMWMWMWMWMWMti=
 *                                                                   . .   :` . :   .  .'.' '....xxxxx...,'. '   ' ."""YWMWMWMWMWMWMWMWMWMW+
 *                                                                ; . ` .  . : . .' :  . ..XXXXXXXXXXXXXXXXXXXXx.    `     . "YWMWMWMWMWMWMW
 *                                                           .    .  .  .    . .   .  ..XXXXXXXXWWWWWWWWWWWWWWWWXXXX.  .     .     """""""
 *                                                                   ' :  : . : .  ...XXXXXWWW"   W88N88@888888WWWWWXX.   .   .       . .
 *                                                              . ' .    . :   ...XXXXXXWWW"    M88N88GGGGGG888^8M "WMBX.          .   ..  :
 *                                                                    :     ..XXXXXXXXWWW"     M88888WWRWWWMW8oo88M   WWMX.     .    :    .
 *                                                                      "XXXXXXXXXXXXWW"       WN8888WWWWW  W8@@@8M    BMBRX.         .  : :
 *                                                             .       XXXXXXXX=MMWW":  .      W8N888WWWWWWWW88888W      XRBRXX.  .       .
 *                                                                ....  ""XXXXXMM::::. .        W8@889WWWWWM8@8N8W      . . :RRXx.    .
 *                                                                    ``...'''  MMM::.:.  .      W888N89999888@8W      . . ::::"RXV    .  :
 *                                                            .       ..'''''      MMMm::.  .      WW888N88888WW     .  . mmMMMMMRXx
 *                                                                 ..' .            ""MMmm .  .       WWWWWWW   . :. :,miMM"""  : ""`    .
 *                                                              .                .       ""MMMMmm . .  .  .   ._,mMMMM"""  :  ' .  :
 *                                                                          .                  ""MMMMMMMMMMMMM""" .  : . '   .        .
 *                                                                     .              .     .    .                      .         .
 *                                                           .                                         .          .         .
 *           
 * 
 * 👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️                                                
 *
 * LINKS:[
 * 
 *         https://web3js.readthedocs.io/en/v1.2.0/web3-eth-contract.html#id36
 *         https://ethereum.stackexchange.com/questions/35997/how-to-listen-to-events-using-web3-v1-0/49472
 *         https://ethereumdev.io/listening-to-new-transactions-happening-on-the-blockchain/
 *  
 * ] 
 * 
 *                                                                IMPLEMENTATION OF MONITOR FOR EVM TYPE 0(via tracks in data field of txs)
 * 
 */


/*


REQUIRED OPTIONS TO USE MONITOR:

    URL:"http://youhostchainnode:<port>", - URL for node which accept RPC, API calls to query data. It might be your own node, NaaS service, "trusted" gateway, your own gateway which take info from several sources and so on

        * in some cases, URL will require some API token or smth like that. Use HTTPS only

    MODE:"PARANOIC" | "TRUST" - behavior for monitor. PARANOIC - you'll track hostchains on your own, block by block to make sure everything is ok. TRUST - you just ask another "trusted" instance about checkpoints

    START_FROM - height to start to monitor from

OPTIONAL

    TARGET:"<address or contract to track>"


*/


import Web3 from 'web3'


//________________________________________________ SIMPLE BLOCK LISTENER ___________________________________________________


// BSC example

// const web3 = new Web3('https://data-seed-prebsc-1-s1.binance.org:8545')
// let latestKnownBlockNumber = -1;
// let blockTime = 5000;

// Our function that will triggered for every block
// async function processBlock(blockNumber) {
//     console.log("We process block: " + blockNumber)
//     latestKnownBlockNumber = blockNumber;
    
//     let block = await web3.eth.getBlock(blockNumber);
//     console.log("New block :", block)
// }

// // This function is called every blockTime, check the current block number and order the processing of the new block(s)
// async function checkCurrentBlock() {
//     const currentBlockNumber = await web3.eth.getBlockNumber()
//     console.log("Current blockchain top: " + currentBlockNumber, " | Script is at: " + latestKnownBlockNumber)
//     while (latestKnownBlockNumber == -1 || currentBlockNumber > latestKnownBlockNumber) {
//         await processBlock(latestKnownBlockNumber == -1 ? currentBlockNumber : latestKnownBlockNumber + 1);
//     }
//     setTimeout(checkCurrentBlock, blockTime);
// }

// checkCurrentBlock()



//Make it global
let configs,web3




let FIND_FIRST_BLOCK_OF_DAY = async evmChainTicker => {

    let startOfDay = new Date()
        
    startOfDay.setUTCHours(0,0,0,0)

    let dayStartTimestampInSeconds=startOfDay.getTime()/1000,

        bestBlock = await web3.eth.getBlock(await web3.eth.getBlockNumber()),

        step = CONFIG.SYMBIOTE.MONITORING.HOSTCHAINS[evmChainTicker].FIRST_BLOCK_FIND_STEP,

        candidateIndex = bestBlock.number - step


    //Go through the chain from the top block to the latest block yesterday(UTC)

    while(true){

        let candidate = await web3.eth.getBlock(candidateIndex).catch(e=>console.log(e))

        console.log('CANDIDATE ',candidate)

        if(candidate.timestamp>dayStartTimestampInSeconds){

            candidateIndex-=step

        }else{

            let possibleIndex = candidate.number

            //Start another reversed cycle to find really first block
            while(true){

                let block = await web3.eth.getBlock(possibleIndex)

                if(block.timestamp>dayStartTimestampInSeconds) return block
                
                else possibleIndex++

            }

        }

    }

}




export default (evmChainTicker) => {

    configs = CONFIG.SYMBIOTE.MONITORING.HOSTCHAINS[evmChainTicker]

    web3 = new Web3(configs.URL)

    

    if(configs.MODE==='PARANOIC'){

        FIND_FIRST_BLOCK_OF_DAY(evmChainTicker).then(block=>console.log(`(${evmChainTicker}) Get best block `,block))

        //Check entire blockthread
        // setInterval(async()=>{

            
        //     // let block = await web3.eth.getBlock(SYMBIOTE_META.VERIFICATION_THREAD.HOSTCHAINS_MONITORING[evmChainTicker].START_FROM)

        //     // console.log(evmChainTicker,' => ',block)

        //     // SYMBIOTE_META.VERIFICATION_THREAD.HOSTCHAINS_MONITORING[evmChainTicker].START_FROM++

    
        // },3000)
    

    }else if(configs.MODE==='TRUST'){

        //Ask some node(or gateway) about checkpoints to avoid enumerating itself

        setInterval(()=>{})

    }

}