/**
 * 
 * 
 *                                                            * .           ..         .           .       .           .           .
 *                                                                 .         .            .          .       .
 *                                                                       .         ..xxxxxxxxxx....               .       .             .
 *                                                               .             MWMWMWWMWMWMWMWMWMWMWMWMW                       .
 *                                                                         IIIIMWMWMWMWMWMWMWMWMWMWMWMWMWMttii:        .           .
 *                                                            .      IIYVVXMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWxx...         .           .
 *                                                                IWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMx..
 *                                                              IIWMWMWMWMWMWMWMWMWBY%ZACH%AND%OWENMWMWMWMWMWMWMWMWMWMWMWMWMx..        .
 *                                                               ""MWMWMWMWMWM"""""""".  .:..   ."""""MWMWMWMWMWMWMWMWMWMWMWMWMWti.
 *                                                            .     ""   . `  .: . :. : .  . :.  .  . . .  """"MWMWMWMWMWMWMWMWMWMWMWMWMti=
 *                                                                   . .   :` . :   .  .'.' '....xxxxx...,'. '   ' ."""YWMWMWMWMWMWMWMWMWMW+
 *                                                                ; . ` .  . : . .' :  . ..XXXXXXXXXXXXXXXXXXXXx.    `     . "YWMWMWMWMWMWMW
 *                                                           .    .  .  .    . .   .  ..XXXXXXXXWWWWWWWWWWWWWWWWXXXX.  .     .     """""""
 *                                                                   ' :  : . : .  ...XXXXXWWW"   W88N88@888888WWWWWXX.   .   .       . .
 *                                                              . ' .    . :   ...XXXXXXWWW"    M88N88GGGGGG888^8M "WMBX.          .   ..  :
 *                                                                    :     ..XXXXXXXXWWW"     M88888WWRWWWMW8oo88M   WWMX.     .    :    .
 *                                                                      "XXXXXXXXXXXXWW"       WN8888WWWWW  W8@@@8M    BMBRX.         .  : :
 *                                                             .       XXXXXXXX=MMWW":  .      W8N888WWWWWWWW88888W      XRBRXX.  .       .
 *                                                                ....  ""XXXXXMM::::. .        W8@889WWWWWM8@8N8W      . . :RRXx.    .
 *                                                                    ``...'''  MMM::.:.  .      W888N89999888@8W      . . ::::"RXV    .  :
 *                                                            .       ..'''''      MMMm::.  .      WW888N88888WW     .  . mmMMMMMRXx
 *                                                                 ..' .            ""MMmm .  .       WWWWWWW   . :. :,miMM"""  : ""`    .
 *                                                              .                .       ""MMMMmm . .  .  .   ._,mMMMM"""  :  ' .  :
 *                                                                          .                  ""MMMMMMMMMMMMM""" .  : . '   .        .
 *                                                                     .              .     .    .                      .         .
 *                                                           .                                         .          .         .
 *           
 * 
 * 👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️                                                
 *
 * LINKS:[
 * 
 *         https://web3js.readthedocs.io/en/v1.2.0/web3-eth-contract.html#id36
 *         https://ethereum.stackexchange.com/questions/35997/how-to-listen-to-events-using-web3-v1-0/49472
 *         https://ethereumdev.io/listening-to-new-transactions-happening-on-the-blockchain/
 *  
 * ] 
 * 
 *                                       IMPLEMENTATION OF MONITOR FOR EVM TYPE 0(via tracks in data field of txs when interact with simple contract with a single event)
 * 
 */


/*


!MANIFEST OPTIONS:

    ?CONTRACT:"0x77D4e0dc185409B9f20f58127146692A81272799" - address of contract to grab VM logs


!REQUIRED OPTIONS TO USE MONITOR:

    ?URL:"http://youhostchainnode:<port>", - URL for node which accept RPC, API calls to query data. It might be your own node, NaaS service, "trusted" gateway, your own gateway which take info from several sources and so on

        * in some cases, URL will require some API token or smth like that. Use HTTPS only

    ?MODE:"PARANOIC" | "TRUST" - behavior for monitor. PARANOIC - you'll track hostchains on your own, block by block to make sure everything is ok. TRUST - you just ask another "trusted" instance about checkpoints

    ?CONTRACT - address of contract to track

    ?ABI - JSON'ed ABI of contract

    ?FIRST_BLOCK_FIND_STEP - step to find first block of the day


    The following options must be in section MONITORING_PRESET

        ?START_FROM - height to start to monitor from

*/


import Web3 from 'web3'




//Make it global
let configs,web3,




GET_CONTRACT_EVENTS = evmChainTicker => {


    let {ABI,CONTRACT} = CONFIG.SYMBIOTE.MONITORS[evmChainTicker],
    
        contractInstance = new web3.eth.Contract(ABI,CONTRACT),
    
        //Get from the height we stopped till the last known block
        options = {
    
            fromBlock: SYMBIOTE_META.VERIFICATION_THREAD.HOSTCHAINS_MONITORING[evmChainTicker].START_FROM,
        
            toBlock:'latest',
    
        };
    
    return contractInstance.getPastEvents('Checkpoint',options)

},




FIND_FIRST_BLOCK_OF_DAY = async evmChainTicker => {

    let startOfDay = new Date()
        
    startOfDay.setUTCHours(0,0,0,0)

    let dayStartTimestampInSeconds=startOfDay.getTime()/1000,

        bestBlock = await web3.eth.getBlock(await web3.eth.getBlockNumber()).catch(e=>false),

        step = CONFIG.SYMBIOTE.MONITORS[evmChainTicker].FIRST_BLOCK_FIND_STEP,

        candidateIndex = bestBlock.number - step


    if(candidateIndex<0) candidateIndex = 0

    //Go through the chain from the top block to the latest block yesterday(UTC)

    while(true){

        let candidate = await web3.eth.getBlock(candidateIndex).catch(e=>false)

        if(candidate.timestamp>=dayStartTimestampInSeconds){

            if(candidateIndex===0) return candidate //if even the initial block(0 in probably all the cryptos,at least in EVM compatible) was generated today - no sense to assume that there is earlier blocks

            candidateIndex-=step

            if(candidateIndex<0) candidateIndex = 0

        }else{

            let possibleIndex = candidate.number


            //Start another reversed cycle to find really first block
            while(true){

                let block = await web3.eth.getBlock(possibleIndex).catch(e=>false)

                if(block.timestamp>=dayStartTimestampInSeconds) return block
                
                else possibleIndex++

            }

        }

    }

}




export default (evmChainTicker) => {

    configs = CONFIG.SYMBIOTE.MONITORS[evmChainTicker]

    web3 = new Web3(configs.URL)
    

    if(configs.MODE==='PARANOIC'){

        GET_CONTRACT_EVENTS(evmChainTicker).then(events=>{

            events.forEach(event=>{

                console.log('Find checkpoints ',event.returnValues.payload)

            })

        })

        FIND_FIRST_BLOCK_OF_DAY(evmChainTicker).then(block=>{

            console.log('First is ',block)

        })

    }else if(configs.MODE==='TRUST'){

        //Ask some node(or gateway) about checkpoints to avoid enumerating itself

        setInterval(()=>{})

    }

}