/**
 * 
 * 
 *                                                            * .           ..         .           .       .           .           .
 *                                                                 .         .            .          .       .
 *                                                                       .         ..xxxxxxxxxx....               .       .             .
 *                                                               .             MWMWMWWMWMWMWMWMWMWMWMWMW                       .
 *                                                                         IIIIMWMWMWMWMWMWMWMWMWMWMWMWMWMttii:        .           .
 *                                                            .      IIYVVXMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWxx...         .           .
 *                                                                IWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMWMx..
 *                                                              IIWMWMWMWMWMWMWMWMWBY%ZACH%AND%OWENMWMWMWMWMWMWMWMWMWMWMWMWMx..        .
 *                                                               ""MWMWMWMWMWM"""""""".  .:..   ."""""MWMWMWMWMWMWMWMWMWMWMWMWMWti.
 *                                                            .     ""   . `  .: . :. : .  . :.  .  . . .  """"MWMWMWMWMWMWMWMWMWMWMWMWMti=
 *                                                                   . .   :` . :   .  .'.' '....xxxxx...,'. '   ' ."""YWMWMWMWMWMWMWMWMWMW+
 *                                                                ; . ` .  . : . .' :  . ..XXXXXXXXXXXXXXXXXXXXx.    `     . "YWMWMWMWMWMWMW
 *                                                           .    .  .  .    . .   .  ..XXXXXXXXWWWWWWWWWWWWWWWWXXXX.  .     .     """""""
 *                                                                   ' :  : . : .  ...XXXXXWWW"   W88N88@888888WWWWWXX.   .   .       . .
 *                                                              . ' .    . :   ...XXXXXXWWW"    M88N88GGGGGG888^8M "WMBX.          .   ..  :
 *                                                                    :     ..XXXXXXXXWWW"     M88888WWRWWWMW8oo88M   WWMX.     .    :    .
 *                                                                      "XXXXXXXXXXXXWW"       WN8888WWWWW  W8@@@8M    BMBRX.         .  : :
 *                                                             .       XXXXXXXX=MMWW":  .      W8N888WWWWWWWW88888W      XRBRXX.  .       .
 *                                                                ....  ""XXXXXMM::::. .        W8@889WWWWWM8@8N8W      . . :RRXx.    .
 *                                                                    ``...'''  MMM::.:.  .      W888N89999888@8W      . . ::::"RXV    .  :
 *                                                            .       ..'''''      MMMm::.  .      WW888N88888WW     .  . mmMMMMMRXx
 *                                                                 ..' .            ""MMmm .  .       WWWWWWW   . :. :,miMM"""  : ""`    .
 *                                                              .                .       ""MMMMmm . .  .  .   ._,mMMMM"""  :  ' .  :
 *                                                                          .                  ""MMMMMMMMMMMMM""" .  : . '   .        .
 *                                                                     .              .     .    .                      .         .
 *                                                           .                                         .          .         .
 *           
 * 
 * 👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️👁️‍🗨️                                                
 *
 * LINKS:[
 * 
 *         https://web3js.readthedocs.io/en/v1.2.0/web3-eth-contract.html#id36
 *         https://ethereum.stackexchange.com/questions/35997/how-to-listen-to-events-using-web3-v1-0/49472
 *         https://ethereumdev.io/listening-to-new-transactions-happening-on-the-blockchain/
 *  
 * ] 
 * 
 *                                       IMPLEMENTATION OF MONITOR FOR EVM PACK_0(via events by EVM when we push a checkpoint to some chain)
 * 
 */


/*


!MANIFEST OPTIONS:

    ?CONTRACT:"0x77D4e0dc185409B9f20f58127146692A81272799" - address of contract to grab VM logs


!REQUIRED OPTIONS TO USE MONITOR:

    ?URL:"http://youhostchainnode:<port>", - URL for node which accept RPC, API calls to query data. It might be your own node, NaaS service, "trusted" gateway, your own gateway which take info from several sources and so on

        * in some cases, URL will require some API token or smth like that. Use HTTPS only

    ?MODE:"PARANOIC" | "TRUST" - behavior for monitor. PARANOIC - you'll track hostchains on your own, block by block to make sure everything is ok. TRUST - you just ask another "trusted" instance about checkpoints

    ?CONTRACT - address of contract to track

    ?ABI - JSON'ed ABI of contract

    ?FIRST_BLOCK_FIND_STEP - step to find first block of the day


    The following options must be in section MONITORING_PRESET

        ?START_FROM - height to start to monitor from

*/



import {LOG} from '../../../KLY_Utils/utils.js'
import Web3 from 'web3'




//Make it global
let configs,web3,




GET_CONTRACT_EVENTS = async evmChainTicker => {


    let {ABI,CONTRACT} = CONFIG.SYMBIOTE.MONITORS[evmChainTicker],
    
        contractInstance = new web3.eth.Contract(ABI,CONTRACT),

        lastKnownBlockNumber = await web3.eth.getBlockNumber().catch(e=>false)


    if(lastKnownBlockNumber){


        console.log(lastKnownBlockNumber)

        LOG(`Found new latest known block on hostchain \x1b[35;1m${evmChainTicker}\x1b[36;1m => \x1b[32;1m${lastKnownBlockNumber}`,'I')

        //Get from the height we stopped till the last known block
        
        let options = {
    
            fromBlock:SYMBIOTE_META.VERIFICATION_THREAD.HOSTCHAINS_MONITORING[evmChainTicker].START_FROM,

            toBlock:lastKnownBlockNumber
    
        };
    
        let events = await contractInstance.getPastEvents('Checkpoint',options).catch(e=>false)

        return [lastKnownBlockNumber,events]

    }else return []
        
},



CHECK_IF_THE_SAME_DAY=(timestamp1,timestamp2)=>{

    let date1 = new Date(timestamp1*1000),
        
        date2 = new Date(timestamp2*1000)

    return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate()

},




FIND_FIRST_BLOCK_OF_DAY = async evmChainTicker => {

    let startOfDay = new Date()
        
    startOfDay.setUTCHours(0,0,0,0)

    let dayStartTimestampInSeconds=startOfDay.getTime()/1000,

        bestBlock = await web3.eth.getBlock(await web3.eth.getBlockNumber()).catch(e=>false),

        step = CONFIG.SYMBIOTE.MONITORS[evmChainTicker].FIRST_BLOCK_FIND_STEP,

        candidateIndex = bestBlock.number - step


    if(candidateIndex<0) candidateIndex = 0

    //Go through the chain from the top block to the latest block yesterday(UTC)

    while(true){

        let candidate = await web3.eth.getBlock(candidateIndex).catch(e=>false)

        if(candidate.timestamp>=dayStartTimestampInSeconds){

            if(candidateIndex===0) return candidate //if even the initial block(0 in probably all the cryptos,at least in EVM compatible) was generated today - no sense to assume that there is earlier blocks

            candidateIndex-=step

            if(candidateIndex<0) candidateIndex = 0

        }else{

            let possibleIndex = candidate.number


            //Start another reversed cycle to find really first block
            while(true){

                let block = await web3.eth.getBlock(possibleIndex).catch(e=>false)

                if(block.timestamp>=dayStartTimestampInSeconds) return block
                
                else possibleIndex++

            }

        }

    }

}




/*

Checkpoint structure

Header:

{
    PAYLOAD_HASH: <32 bytes BLAKE3 HASH OF CHECKPOINT PAYLOAD. Quorum sign this hash>
    
    QUORUM_AGGREGATED_SIGNERS_PUBKEY:<48 bytes BLS AGGREGATED PUBKEY OF VALIDATORS FROM CURRENT QUORUM WHO SIGNED CHECKPOINT>

    QUORUM_AGGREGATED_SIGNATURE:<96 bytes BLS AGGREGATED SIGNATURE which verified by aggregated pubkey>

    AFK_SIGNERS:<ARRAY OF AFK VALIDATORS FROM QUORUM WHO SKIPPED CHECKPOINT GENERATION PROCEDURE.48 BYTES PER PUBKEY>

}

If QUORUM SIZE=127 and threshold is 2/3N+1 (required by typical BFT), then count the worst case - when N/3 is AFK, malicious activity or some other problem(poor connection,fault and so on)

N/3=42

Then, the biggest possible checkpoint size is:

32 - checkpoint payload hash.
+
48 - aggregated BLS pubkey of signers
+
96 - aggregated signature
+
48*42
______________________

2192 bytes - the biggest possible checkpoint size in case QUORUM SIZE=127(validators number might be infinite)


-------------------------------------------------------------Checkpoint payload-------------------------------------------------------------

Checkpoint payload contains:

OTHER_CHECKPOINTS (KEY=>VALUE) => (SYMBIOTE_ID=>CHECKPOINT_HEADER) - object with checkpoints from other symbiotes to perform Hivemind activity

VALIDATORS_METADATA - object like this

        {
            '7GPupbq1vtKUgaqVeHiDbEJcxS7sSjwPnbht4eRaDBAEJv8ZKHNCSu2Am3CuWnHjta': {
                INDEX: -1,
                HASH: 'Poyekhali!@Y.A.Gagarin',
                BLOCKS_GENERATOR: true
            }
    
        }

    Key - BLS pubkey of validator
    Value - object to track progress to verify blocks step-by-step





*/


export default async(evmChainTicker) => {

    configs = CONFIG.SYMBIOTE.MONITORS[evmChainTicker]

    web3 = new Web3(configs.URL)

    if(configs.MODE==='PARANOIC'){

        let [lastKnownBlockNumber,events] = await GET_CONTRACT_EVENTS(evmChainTicker)

        if(lastKnownBlockNumber && events){

            console.log(lastKnownBlockNumber,' => ',events)

            console.log(SYMBIOTE_META.VERIFICATION_THREAD)


        }else LOG(`Can't get events from the current provider.Try to make troubleshouting of your node provider`,'F')


        // FIND_FIRST_BLOCK_OF_DAY(evmChainTicker).then(block=>{

        //     console.log('First is ',block)

        // })

    }else if(configs.MODE==='TRUST'){

        //Ask some node(or gateway) about checkpoints to avoid enumerating itself

        setInterval(()=>{})

    }

} 